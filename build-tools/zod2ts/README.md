# zod2ts

A TypeScript command line tool that extracts fully realized TypeScript types from Zod schemas using direct schema introspection.

## Features

- Extracts TypeScript types from Zod schemas
- Supports multiple schemas in a single file
- Generates individual TypeScript files for each schema
- Follows naming convention: `FooSchema` ‚Üí `Foo.ts`
- Provides detailed error messages and validation

**Note**: This tool uses a **bundled dependencies approach** with string replacement to ensure it works reliably in any environment without requiring external zod installations. It generates fully resolved TypeScript types from Zod schemas using direct schema introspection and supports complex Zod types including objects, arrays, unions, enums, literals, and more.

## Key Benefits

üöÄ **Zero Dependencies**: No need to install zod in your project - everything is bundled
‚ö° **Universal Compatibility**: Works in any Node.js environment
üîß **Flexible Input**: Supports both TypeScript (.ts) and JavaScript (.js) schema files
üõ°Ô∏è **Safe Execution**: Controlled evaluation environment prevents security issues
üì¶ **Self-Contained**: Single executable with all dependencies bundled

## Installation

This tool is part of the saga-soa monorepo and comes with a **self-contained bundled version** that requires no external dependencies.

### For saga-soa Development

Install dependencies from the root:

```bash
pnpm install
```

### For External Use

The tool works out-of-the-box without any installation requirements - simply use the bundled CLI binary.

## Usage

### Basic Usage

```bash
# Using the bundled CLI (works anywhere)
/path/to/build-tools/zod2ts/bin/zod2ts --zod-path ./src/schemas/user.ts --output-dir ./src/types

# From within saga-soa project
./bin/zod2ts --zod-path ./src/schemas/user.ts --output-dir ./src/types
```

### Parameters

- `--zod-path <path>`: Path to TypeScript file containing Zod schemas (required)
- `--output-dir <path>`: Output directory for generated type files (required)

### Examples

#### Mixed Schema Types

Given a file `schemas/mixed.ts`:

```typescript
import { z } from 'zod';

// Schema ending with 'Schema' - will remove suffix
export const UserSchema = z.object({
  id: z.string(),
  name: z.string(),
  email: z.string().email(),
});

// Schema not ending with 'Schema' - will use name as-is
export const Product = z.object({
  id: z.string(),
  title: z.string(),
  price: z.number(),
});

// Another schema ending with 'Schema'
export const OrderSchema = z.object({
  id: z.string(),
  items: z.array(z.string()),
  total: z.number(),
});
```

Running:

```bash
./bin/zod2ts --zod-path ./schemas/mixed.ts --output-dir ./types
```

Will generate:

- `types/User.ts` - TypeScript type for UserSchema
- `types/Product.ts` - TypeScript type for Product
- `types/Order.ts` - TypeScript type for OrderSchema

#### Using Type Name Override

```bash
./bin/zod2ts --zod-path ./schemas/mixed.ts --output-dir ./types --type-name CustomType
```

Will generate:

- `types/CustomType.ts` - TypeScript type for UserSchema
- `types/CustomType1.ts` - TypeScript type for Product
- `types/CustomType2.ts` - TypeScript type for OrderSchema

#### Complex Schema with Advanced Types

Given a file `schemas/complex.ts`:

```typescript
import { z } from 'zod';

export const ComplexSchema = z.object({
  id: z.string().uuid(),
  metadata: z.object({
    tags: z.array(z.string()),
    categories: z.array(
      z.object({
        id: z.number(),
        name: z.string(),
        color: z.string().regex(/^#[0-9A-F]{6}$/i),
      })
    ),
  }),
  status: z.enum(['draft', 'published', 'archived']),
  content: z.union([
    z.object({
      type: z.literal('text'),
      value: z.string(),
    }),
    z.object({
      type: z.literal('image'),
      url: z.string().url(),
      alt: z.string(),
    }),
  ]),
  timestamps: z.object({
    created: z.date(),
    updated: z.date().optional(),
  }),
});
```

Running:

```bash
./bin/zod2ts --zod-path ./schemas/complex.ts --output-dir ./types
```

Will generate:

- `types/Complex.ts` - TypeScript type for ComplexSchema with fully resolved types

### Generated Output Examples

#### User Schema Output (`types/User.ts`)

```typescript
// Generated by zod2ts
// Do not edit manually

export type User = {
  id: string;
  name: string;
  email: string;
  age: number | undefined;
  createdAt: Date;
};
```

#### Complex Schema Output (`types/Complex.ts`)

```typescript
// Generated by zod2ts
// Do not edit manually

export type Complex = {
  id: string;
  metadata: {
    tags: string[];
    categories: {
      id: number;
      name: string;
      color: string;
    }[];
  };
  status: 'draft' | 'published' | 'archived';
  content:
    | {
        type: 'text';
        value: string;
      }
    | {
        type: 'image';
        url: string;
        alt: string;
      };
  timestamps: {
    created: Date;
    updated: Date | undefined;
  };
};
```

## Smart Naming Convention

The tool intelligently names generated types based on the schema variable names:

### Default Behavior:

- **Schemas ending with `Schema`**: Removes the `Schema` suffix

  - `UserSchema` ‚Üí generates `User` type
  - `ProductSchema` ‚Üí generates `Product` type
  - `OrderItemSchema` ‚Üí generates `OrderItem` type

- **Schemas not ending with `Schema`**: Uses the schema name as-is
  - `User` ‚Üí generates `User` type
  - `Product` ‚Üí generates `Product` type
  - `OrderItem` ‚Üí generates `OrderItem` type

### Override Behavior:

Use the `--type-name` parameter to override the default naming:

- All schemas will use the specified name (with automatic numbering for conflicts)
  - `--type-name CustomType` ‚Üí generates `CustomType`, `CustomType1`, `CustomType2`, etc.

## Error Handling

The tool provides clear error messages for common issues:

- **File not found**: When the specified Zod file doesn't exist
- **No schemas found**: When no variables ending with `Schema` are found
- **Invalid schema**: When a variable ending with `Schema` is not a valid Zod schema
- **Schema loading errors**: When there are issues importing or parsing the schema file
- **Type generation errors**: When there are problems generating TypeScript types from schemas

### Example Error Messages

```bash
# File not found
‚ùå Error: File not found: /path/to/nonexistent/schema.ts

# No schemas found
‚ùå Error: No schemas found in file: /path/to/file.ts. Expected Zod schema variables

# Schema loading error
‚ùå Error: Failed to load schemas from /path/to/file.ts: Cannot find module 'zod'
```

## Development

### Building

```bash
cd tools/zod2ts
pnpm build
```

### Testing

```bash
cd tools/zod2ts
pnpm test
```

### Development Mode

```bash
cd tools/zod2ts
pnpm dev
```

### Project Structure

```
‚îú‚îÄ‚îÄ zod2ts                 # Convenience script
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ zod2ts             # Main executable bin stub
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # CLI entry point
‚îÇ   ‚îú‚îÄ‚îÄ schema-extractor.ts   # Main orchestration logic
‚îÇ   ‚îú‚îÄ‚îÄ zod-loader.ts         # Dynamic schema loading
‚îÇ   ‚îú‚îÄ‚îÄ type-generator.ts     # TypeScript type generation
‚îÇ   ‚îú‚îÄ‚îÄ file-utils.ts         # File system utilities
‚îÇ   ‚îî‚îÄ‚îÄ types.ts              # Type definitions and errors
‚îî‚îÄ‚îÄ __tests__/
    ‚îú‚îÄ‚îÄ fixtures/             # Test schema files
    ‚îî‚îÄ‚îÄ schema-extractor.test.ts
```

### Architecture

The tool uses a modular architecture with clear separation of concerns:

- **SchemaExtractor**: Orchestrates the extraction process
- **ZodSchemaLoader**: Handles dynamic imports and schema validation
- **TypeGenerator**: Converts Zod schemas to TypeScript types
- **FileUtils**: Manages file system operations

## Technical Details

### Bundled Dependencies Approach

zod2ts uses a **string replacement + bundled dependencies** approach that ensures universal compatibility:

- **‚úÖ No external dependencies required** - zod is bundled into the CLI
- **‚úÖ Works anywhere Node.js runs** - no zod installation needed in target projects
- **‚úÖ Handles both TypeScript and JavaScript** schema files
- **‚úÖ Self-contained executable** - single binary with all dependencies

For detailed technical information about this approach, see: [Bundled Zod Approach Documentation](./docs/bundled-zod-approach.md)

### Core Technologies

- **Zod**: Bundled for schema validation and type introspection
- **zod-to-ts**: Bundled for TypeScript type generation
- **commander**: For CLI argument parsing

### Extraction Process

1. **Reads schema file content** as plain text (supports both .ts and .js)
2. **Replaces zod imports** with bundled references using string replacement
3. **Transforms ES modules** to CommonJS format for evaluation
4. **Safely evaluates** the transformed code in a controlled environment
5. **Extracts Zod schemas** from the module exports
6. **Generates TypeScript types** using bundled zod-to-ts
7. **Writes individual files** for each schema

### Type Generation Approach

The tool uses direct Zod schema introspection to generate TypeScript types, which provides several advantages:

- **Full type resolution**: Generates literal types instead of generic `Record<string, any>`
- **Runtime accuracy**: Types match exactly what Zod validates at runtime
- **No external dependencies**: Uses only Zod's built-in type system
- **Fast execution**: Direct schema analysis without complex AST manipulation

### Supported Zod Schema Features

The type generator handles all major Zod schema features:

- **Primitive types**: `z.string()`, `z.number()`, `z.boolean()`, `z.date()`, etc.
- **Complex objects**: Nested objects with typed properties
- **Arrays**: Typed arrays with element type inference
- **Unions**: Discriminated unions and simple unions
- **Enums**: String literal unions
- **Optional/nullable**: Proper `| undefined` and `| null` handling
- **Literals**: Exact value types
- **Defaults**: Handles default values appropriately

## Supported Zod Types

This tool supports the following Zod schema types:

- **Primitive types**: `z.string()`, `z.number()`, `z.boolean()`, `z.date()`, `z.null()`, `z.undefined()`, `z.any()`, `z.unknown()`
- **Object types**: `z.object()` with nested properties
- **Array types**: `z.array()` with typed elements
- **Union types**: `z.union()` with multiple options
- **Optional types**: `z.optional()` and `z.nullable()`
- **Enum types**: `z.enum()` with string literals
- **Literal types**: `z.literal()` with specific values

## Integration with saga-soa

This tool is designed to work with the saga-soa project's patterns:

- Uses ESM modules
- Follows the project's TypeScript configuration
- Integrates with the monorepo's build system
- Uses the same testing framework (vitest)
