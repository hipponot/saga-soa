# zod2ts

A TypeScript command line tool that extracts fully realized TypeScript types from Zod schemas using direct schema introspection.

## Features

- Extracts TypeScript types from Zod schemas
- Supports multiple schemas in a single file
- Generates individual TypeScript files for each schema
- Follows naming convention: `FooSchema` → `Foo.ts`
- Provides detailed error messages and validation

**Note**: This tool now generates fully resolved TypeScript types from Zod schemas using direct schema introspection. It supports complex Zod types including objects, arrays, unions, enums, literals, and more.

## Installation

This tool is part of the saga-soa monorepo. Install dependencies from the root:

```bash
pnpm install
```

### Prerequisites

The tool requires `tsx` to be installed globally for TypeScript execution:

```bash
# Install tsx globally
npm install -g tsx
# or
pnpm add -g tsx
```

The bin stubs will automatically check for tsx and provide helpful error messages if it's not installed.

### Available Commands

- `./tools/zod2ts/zod2ts` - Convenience script (recommended)
- `zod2ts` - Main command name

## Usage

### Basic Usage

```bash
# Using the convenience script (recommended)
./tools/zod2ts/zod2ts --zod-path ./src/schemas/user.ts --output-dir ./src/types

# Using the bin stub
tools/zod2ts/bin/zod2ts --zod-path ./src/schemas/user.ts --output-dir ./src/types



# Or using tsx directly
tsx tools/zod2ts/src/index.ts --zod-path ./src/schemas/user.ts --output-dir ./src/types
```

### Parameters

- `--zod-path <path>`: Path to TypeScript file containing Zod schemas (required)
- `--output-dir <path>`: Output directory for generated type files (required)

### Examples

#### Mixed Schema Types

Given a file `schemas/mixed.ts`:

```typescript
import { z } from 'zod';

// Schema ending with 'Schema' - will remove suffix
export const UserSchema = z.object({
  id: z.string(),
  name: z.string(),
  email: z.string().email(),
});

// Schema not ending with 'Schema' - will use name as-is
export const Product = z.object({
  id: z.string(),
  title: z.string(),
  price: z.number(),
});

// Another schema ending with 'Schema'
export const OrderSchema = z.object({
  id: z.string(),
  items: z.array(z.string()),
  total: z.number(),
});
```

Running:

```bash
./tools/zod2ts/zod2ts --zod-path ./schemas/mixed.ts --output-dir ./types
```

Will generate:

- `types/User.ts` - TypeScript type for UserSchema
- `types/Product.ts` - TypeScript type for Product
- `types/Order.ts` - TypeScript type for OrderSchema

#### Using Type Name Override

```bash
./tools/zod2ts/zod2ts --zod-path ./schemas/mixed.ts --output-dir ./types --type-name CustomType
```

Will generate:

- `types/CustomType.ts` - TypeScript type for UserSchema
- `types/CustomType1.ts` - TypeScript type for Product
- `types/CustomType2.ts` - TypeScript type for OrderSchema

#### Complex Schema with Advanced Types

Given a file `schemas/complex.ts`:

```typescript
import { z } from 'zod';

export const ComplexSchema = z.object({
  id: z.string().uuid(),
  metadata: z.object({
    tags: z.array(z.string()),
    categories: z.array(
      z.object({
        id: z.number(),
        name: z.string(),
        color: z.string().regex(/^#[0-9A-F]{6}$/i),
      })
    ),
  }),
  status: z.enum(['draft', 'published', 'archived']),
  content: z.union([
    z.object({
      type: z.literal('text'),
      value: z.string(),
    }),
    z.object({
      type: z.literal('image'),
      url: z.string().url(),
      alt: z.string(),
    }),
  ]),
  timestamps: z.object({
    created: z.date(),
    updated: z.date().optional(),
  }),
});
```

Running:

```bash
./tools/zod2ts/zod2ts --zod-path ./schemas/complex.ts --output-dir ./types
```

Will generate:

- `types/Complex.ts` - TypeScript type for ComplexSchema with fully resolved types

### Generated Output Examples

#### User Schema Output (`types/User.ts`)

```typescript
// Generated by zod2ts
// Do not edit manually

export type User = {
  id: string;
  name: string;
  email: string;
  age: number | undefined;
  createdAt: Date;
};
```

#### Complex Schema Output (`types/Complex.ts`)

```typescript
// Generated by zod2ts
// Do not edit manually

export type Complex = {
  id: string;
  metadata: {
    tags: string[];
    categories: {
      id: number;
      name: string;
      color: string;
    }[];
  };
  status: 'draft' | 'published' | 'archived';
  content:
    | {
        type: 'text';
        value: string;
      }
    | {
        type: 'image';
        url: string;
        alt: string;
      };
  timestamps: {
    created: Date;
    updated: Date | undefined;
  };
};
```

## Smart Naming Convention

The tool intelligently names generated types based on the schema variable names:

### Default Behavior:

- **Schemas ending with `Schema`**: Removes the `Schema` suffix

  - `UserSchema` → generates `User` type
  - `ProductSchema` → generates `Product` type
  - `OrderItemSchema` → generates `OrderItem` type

- **Schemas not ending with `Schema`**: Uses the schema name as-is
  - `User` → generates `User` type
  - `Product` → generates `Product` type
  - `OrderItem` → generates `OrderItem` type

### Override Behavior:

Use the `--type-name` parameter to override the default naming:

- All schemas will use the specified name (with automatic numbering for conflicts)
  - `--type-name CustomType` → generates `CustomType`, `CustomType1`, `CustomType2`, etc.

## Error Handling

The tool provides clear error messages for common issues:

- **File not found**: When the specified Zod file doesn't exist
- **No schemas found**: When no variables ending with `Schema` are found
- **Invalid schema**: When a variable ending with `Schema` is not a valid Zod schema
- **Schema loading errors**: When there are issues importing or parsing the schema file
- **Type generation errors**: When there are problems generating TypeScript types from schemas

### Example Error Messages

```bash
# File not found
❌ Error: File not found: /path/to/nonexistent/schema.ts

# No schemas found
❌ Error: No schemas found in file: /path/to/file.ts. Expected Zod schema variables

# Schema loading error
❌ Error: Failed to load schemas from /path/to/file.ts: Cannot find module 'zod'
```

## Development

### Building

```bash
cd tools/zod2ts
pnpm build
```

### Testing

```bash
cd tools/zod2ts
pnpm test
```

### Development Mode

```bash
cd tools/zod2ts
pnpm dev
```

### Project Structure

```
├── zod2ts                 # Convenience script
├── bin/
│   └── zod2ts             # Main executable bin stub
├── src/
│   ├── index.ts              # CLI entry point
│   ├── schema-extractor.ts   # Main orchestration logic
│   ├── zod-loader.ts         # Dynamic schema loading
│   ├── type-generator.ts     # TypeScript type generation
│   ├── file-utils.ts         # File system utilities
│   └── types.ts              # Type definitions and errors
└── __tests__/
    ├── fixtures/             # Test schema files
    └── schema-extractor.test.ts
```

### Architecture

The tool uses a modular architecture with clear separation of concerns:

- **SchemaExtractor**: Orchestrates the extraction process
- **ZodSchemaLoader**: Handles dynamic imports and schema validation
- **TypeGenerator**: Converts Zod schemas to TypeScript types
- **FileUtils**: Manages file system operations

## Technical Details

This tool uses:

- **Zod**: For schema validation and type introspection
- **commander**: For CLI argument parsing
- **tsx**: For running TypeScript directly

The extraction process:

1. Dynamically imports the TypeScript file containing Zod schemas
2. Identifies all exported variables ending with `Schema`
3. Validates that they are valid Zod schema instances
4. Generates fully resolved TypeScript types using direct schema introspection
5. Writes individual TypeScript files for each schema

### Type Generation Approach

The tool uses direct Zod schema introspection to generate TypeScript types, which provides several advantages:

- **Full type resolution**: Generates literal types instead of generic `Record<string, any>`
- **Runtime accuracy**: Types match exactly what Zod validates at runtime
- **No external dependencies**: Uses only Zod's built-in type system
- **Fast execution**: Direct schema analysis without complex AST manipulation

### Supported Zod Schema Features

The type generator handles all major Zod schema features:

- **Primitive types**: `z.string()`, `z.number()`, `z.boolean()`, `z.date()`, etc.
- **Complex objects**: Nested objects with typed properties
- **Arrays**: Typed arrays with element type inference
- **Unions**: Discriminated unions and simple unions
- **Enums**: String literal unions
- **Optional/nullable**: Proper `| undefined` and `| null` handling
- **Literals**: Exact value types
- **Defaults**: Handles default values appropriately

## Supported Zod Types

This tool supports the following Zod schema types:

- **Primitive types**: `z.string()`, `z.number()`, `z.boolean()`, `z.date()`, `z.null()`, `z.undefined()`, `z.any()`, `z.unknown()`
- **Object types**: `z.object()` with nested properties
- **Array types**: `z.array()` with typed elements
- **Union types**: `z.union()` with multiple options
- **Optional types**: `z.optional()` and `z.nullable()`
- **Enum types**: `z.enum()` with string literals
- **Literal types**: `z.literal()` with specific values

## Integration with saga-soa

This tool is designed to work with the saga-soa project's patterns:

- Uses ESM modules
- Follows the project's TypeScript configuration
- Integrates with the monorepo's build system
- Uses the same testing framework (vitest)
